import type { IExploit, IExploitUID } from '@lib/exploits/interfaces';
import { useEffect, useState } from 'react';
import type { SemVer } from 'semver';

// Somehow this will only resolve when not using aliases (yes, I spent 2 days on this)
// And yes, ts will shout at you
import { validateExploitSchema } from '../../../lib/exploits/schemas/ExploitSchema.js';

export const useExploits = (
	tab: chrome.tabs.Tab | undefined,
	endpoints: Array<URL>
) => {
	const [loaded, setLoaded] = useState<boolean>(false);
	const [exploits, setExploits] = useState<Array<IExploit>>([]);

	useEffect(() => {
		if (!tab || !tab.url) return;
		fetchExploits(tab.url);

		async function fetchExploits(tabUrl: string) {
			let total: Array<IExploit> = [];

			for (const endpoint of endpoints) {
				const resp = await fetch(endpoint);

				if (!resp.ok) continue;

				const exploits = await resp.json();
				if (!Array.isArray(exploits)) continue;

				const validExploits = exploits
					.filter(
						(e) =>
							validateExploitSchema(e) &&
							new RegExp(e.url).test(tabUrl)
					)
					.map((e) => {
						return {
							name: e.name,
							description: e.description,
							location: e.location,
							matches: [new RegExp(e.url)],
							version: e.version as SemVer,
							uid: e.uid as IExploitUID
						} as IExploit;
					});
				total = total.concat(validExploits);
			}
			setLoaded(true);
			setExploits(total);
		}
	}, [tab, endpoints]);

	return { loaded, exploits };
};
